generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Auth & Users ──────────────────────────────────────────

enum Role {
  ADMIN
  BYRALEDNING
  TEAM_LEAD
  MEDARBETARE
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         Role     @default(MEDARBETARE)
  active       Boolean  @default(true)
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employeeMapping UserEmployeeMapping?
  auditLogs       AuditLog[]
  taskComments    TaskComment[]
  periodLocks     PeriodLock[]     @relation("LockedBy")
  periodUnlocks   PeriodLock[]     @relation("UnlockedBy")
  importBatches   ImportBatch[]

  @@map("users")
}

model Employee {
  id                  String   @id @default(cuid())
  employeeNumber      String?  @unique
  name                String
  personalNumber      String?
  costPerHour         Decimal  @db.Decimal(10, 2)
  defaultPricePerHour Decimal  @db.Decimal(10, 2)
  weeklyHours         Decimal  @default(40) @db.Decimal(5, 2)
  targetUtilization   Decimal  @default(0.75) @db.Decimal(5, 4)
  active              Boolean  @default(true)
  deletedAt           DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  userMapping      UserEmployeeMapping?
  costHistory      EmployeeCostHistory[]
  timeEntries      TimeEntry[]
  absences         Absence[]
  assignedTasks    Task[]            @relation("TaskAssignee")
  managedCustomers Customer[]        @relation("ClientManager")

  @@map("employees")
}

model EmployeeCostHistory {
  id            String    @id @default(cuid())
  employeeId    String
  effectiveFrom DateTime  @db.Date
  effectiveTo   DateTime? @db.Date
  costPerHour   Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, effectiveFrom])
  @@map("employee_cost_history")
}

model UserEmployeeMapping {
  id         String @id @default(cuid())
  userId     String @unique
  employeeId String @unique

  user     User     @relation(fields: [userId], references: [id])
  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("user_employee_mapping")
}

// ─── Customers ─────────────────────────────────────────────

enum CustomerType {
  LOPANDE
  FASTPRIS
  BLANDAD
}

model Customer {
  id               String       @id @default(cuid())
  customerNumber   String?      @unique
  name             String
  orgnr            String?      @unique
  postalCode       String?
  city             String?
  country          String?
  phone            String?
  customerType     CustomerType @default(LOPANDE)
  clientManagerId  String?
  segmentId        String?
  active           Boolean      @default(true)
  deletedAt        DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  manager       Employee?        @relation("ClientManager", fields: [clientManagerId], references: [id])
  segment       CustomerSegment? @relation(fields: [segmentId], references: [id])
  timeEntries   TimeEntry[]
  budgetEntries BudgetEntry[]
  tasks         Task[]
  pricingRules  PricingRule[]

  @@map("customers")
}

model CustomerSegment {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customers Customer[]

  @@map("customer_segments")
}

// ─── Articles ──────────────────────────────────────────────

enum ArticleGroupType {
  ORDINARIE
  TILLAGG
  INTERNTID
  OVRIGT
}

model ArticleGroup {
  id        String           @id @default(cuid())
  name      String           @unique
  type      ArticleGroupType
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  articles     Article[]
  pricingRules PricingRule[]

  @@map("article_groups")
}

model Article {
  id             String   @id @default(cuid())
  code           String   @unique
  name           String
  defaultPrice   Decimal?
  articleGroupId String
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  articleGroup  ArticleGroup  @relation(fields: [articleGroupId], references: [id])
  timeEntries   TimeEntry[]
  budgetEntries BudgetEntry[]
  pricingRules  PricingRule[]

  @@map("articles")
}

// ─── Time Entries ──────────────────────────────────────────

model TimeEntry {
  id              String   @id @default(cuid())
  employeeId      String
  customerId      String
  articleId       String
  date            DateTime @db.Date
  hours           Decimal  @db.Decimal(5, 2)
  runningPrice    Decimal? @db.Decimal(12, 2)
  calculatedPrice Decimal? @db.Decimal(12, 2)
  costAmount      Decimal? @db.Decimal(12, 2)
  pricingRuleId   String?
  comment         String?
  invoiceText     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employee    Employee     @relation(fields: [employeeId], references: [id])
  customer    Customer     @relation(fields: [customerId], references: [id])
  article     Article      @relation(fields: [articleId], references: [id])
  pricingRule PricingRule? @relation(fields: [pricingRuleId], references: [id])

  @@index([employeeId, date])
  @@index([customerId, date])
  @@map("time_entries")
}

// ─── Budget ────────────────────────────────────────────────

enum BudgetStatus {
  DRAFT
  PUBLISHED
}

model BudgetEntry {
  id         String       @id @default(cuid())
  year       Int
  month      Int
  customerId String
  articleId  String
  hours      Decimal      @db.Decimal(8, 2)
  amount     Decimal      @default(0) @db.Decimal(12, 2)
  status     BudgetStatus @default(DRAFT)
  version    Int          @default(1)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
  article  Article  @relation(fields: [articleId], references: [id])

  @@unique([year, month, customerId, articleId, status], name: "budget_unique_published")
  @@index([year, month])
  @@map("budget_entries")
}

// ─── Pricing Rules ─────────────────────────────────────────

enum PricingScope {
  GLOBAL
  ARTICLE_GROUP
  ARTICLE
  CUSTOMER
  CUSTOMER_ARTICLE
}

model PricingRule {
  id                  String       @id @default(cuid())
  name                String
  scope               PricingScope
  priority            Int
  pricePerHour        Decimal?     @db.Decimal(10, 2)
  fixedPriceComponent Decimal?     @db.Decimal(12, 2)
  markup              Decimal?     @db.Decimal(5, 4)
  discount            Decimal?     @db.Decimal(5, 4)
  minimumCharge       Decimal?     @db.Decimal(12, 2)
  validFrom           DateTime?    @db.Date
  validTo             DateTime?    @db.Date
  active              Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  articleGroupId String?
  articleId      String?
  customerId     String?

  articleGroup ArticleGroup? @relation(fields: [articleGroupId], references: [id])
  article      Article?      @relation(fields: [articleId], references: [id])
  customer     Customer?     @relation(fields: [customerId], references: [id])
  timeEntries  TimeEntry[]

  @@map("pricing_rules")
}

// ─── Period & Calendar ─────────────────────────────────────

model PeriodLock {
  id         String    @id @default(cuid())
  year       Int
  month      Int
  lockedAt   DateTime  @default(now())
  lockedById String
  unlockedAt DateTime?
  unlockedById String?

  lockedBy   User  @relation("LockedBy", fields: [lockedById], references: [id])
  unlockedBy User? @relation("UnlockedBy", fields: [unlockedById], references: [id])

  @@unique([year, month])
  @@map("period_locks")
}

model CalendarDay {
  date        DateTime @id @db.Date
  isWeekend   Boolean  @default(false)
  isHoliday   Boolean  @default(false)
  holidayName String?
  workHours   Decimal  @default(8) @db.Decimal(4, 2)

  @@map("calendar_days")
}

enum AbsenceReason {
  SEMESTER
  VAB
  SJUK
  FORALDRALEDIG
  FRANVARO_OVRIGT
  FLEXTID
}

model Absence {
  id         String        @id @default(cuid())
  employeeId String
  date       DateTime      @db.Date
  hours      Decimal       @db.Decimal(5, 2)
  reason     AbsenceReason
  code       String?
  comment    String?

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, date])
  @@map("absences")
}

// ─── Tasks & Data Quality ──────────────────────────────────

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      TaskStatus   @default(BACKLOG)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?    @db.Date
  sortOrder   Int          @default(0)
  assigneeId  String?
  customerId  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  assignee Employee?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  customer Customer?     @relation(fields: [customerId], references: [id])
  comments TaskComment[]

  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@map("task_comments")
}

enum RuleSeverity {
  INFO
  WARNING
  ERROR
}

model DataQualityRule {
  id       String       @id @default(cuid())
  name     String
  ruleType String
  config   Json         @default("{}")
  severity RuleSeverity @default(WARNING)
  active   Boolean      @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  issues DataQualityIssue[]

  @@map("data_quality_rules")
}

enum IssueStatus {
  OPEN
  RESOLVED
  IGNORED
}

model DataQualityIssue {
  id         String       @id @default(cuid())
  ruleId     String
  entityType String
  entityId   String
  severity   RuleSeverity @default(WARNING)
  status     IssueStatus  @default(OPEN)
  message    String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  rule DataQualityRule @relation(fields: [ruleId], references: [id])

  @@index([entityType, entityId])
  @@map("data_quality_issues")
}

model Warning {
  id              String       @id @default(cuid())
  type            String
  severity        RuleSeverity @default(WARNING)
  entityType      String
  entityId        String
  message         String
  isAcknowledged  Boolean      @default(false)
  createdAt       DateTime     @default(now())

  @@index([entityType, entityId])
  @@map("warnings")
}

// ─── Import Batches ───────────────────────────────────────

model ImportBatch {
  id          String   @id @default(cuid())
  type        String   // EMPLOYEE, CUSTOMER, ARTICLE, TIME_ENTRY
  count       Int
  entityIds   Json     // string[] — IDs of created records
  createdById String
  createdAt   DateTime @default(now())

  createdBy User @relation(fields: [createdById], references: [id])

  @@map("import_batches")
}

// ─── Audit ─────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_log")
}
